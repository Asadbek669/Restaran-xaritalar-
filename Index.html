<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Toshkent restoranlari</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background-color: #f8f9fa;
      color: #333;
    }
    
    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    
    header {
      background: linear-gradient(135deg, #ff7e5f, #feb47b);
      color: white;
      padding: 15px 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 1000;
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    h1 {
      font-size: 1.4rem;
      font-weight: 600;
    }
    
    .search-container {
      padding: 12px 15px;
      background-color: white;
      border-bottom: 1px solid #eee;
    }
    
    .search-box {
      display: flex;
      align-items: center;
      background: #f0f0f0;
      border-radius: 25px;
      padding: 8px 15px;
    }
    
    .search-box i {
      color: #777;
      margin-right: 10px;
    }
    
    #search-input {
      flex: 1;
      border: none;
      background: transparent;
      outline: none;
      font-size: 1rem;
    }
    
    #map {
      flex: 1;
      width: 100%;
      z-index: 1;
    }
    
    .filters {
      display: flex;
      overflow-x: auto;
      padding: 12px 15px;
      gap: 10px;
      background-color: white;
      border-bottom: 1px solid #eee;
      scrollbar-width: none;
    }
    
    .filters::-webkit-scrollbar {
      display: none;
    }
    
    .filter-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 20px;
      background-color: #f0f0f0;
      color: #555;
      font-size: 0.9rem;
      white-space: nowrap;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .filter-btn.active {
      background: linear-gradient(135deg, #ff7e5f, #feb47b);
      color: white;
    }
    
    .restaurant-list {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top-left-radius: 15px;
      border-top-right-radius: 15px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      transform: translateY(calc(100% - 50px));
      transition: transform 0.3s ease;
      z-index: 1000;
      max-height: 70vh;
      overflow-y: auto;
    }
    
    .restaurant-list.expanded {
      transform: translateY(0);
    }
    
    .list-handle {
      height: 50px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    
    .handle-icon {
      width: 40px;
      height: 5px;
      background: #ddd;
      border-radius: 3px;
    }
    
    .list-content {
      padding: 10px 15px;
    }
    
    .restaurant-item {
      display: flex;
      padding: 15px 0;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
    }
    
    .restaurant-item:last-child {
      border-bottom: none;
    }
    
    .restaurant-info {
      flex: 1;
    }
    
    .restaurant-name {
      font-weight: 600;
      margin-bottom: 5px;
      color: #333;
    }
    
    .restaurant-details {
      display: flex;
      align-items: center;
      color: #777;
      font-size: 0.9rem;
    }
    
    .restaurant-rating {
      display: flex;
      align-items: center;
      margin-right: 15px;
    }
    
    .restaurant-rating i {
      color: #ffc107;
      margin-right: 5px;
    }
    
    .restaurant-cuisine {
      padding: 3px 8px;
      background: #f0f0f0;
      border-radius: 12px;
      font-size: 0.8rem;
    }
    
    .distance {
      margin-left: auto;
      color: #777;
      font-size: 0.9rem;
    }
    
    .custom-marker {
      background: linear-gradient(135deg, #ff7e5f, #feb47b);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .leaflet-popup-content {
      margin: 15px;
      min-width: 200px;
    }
    
    .popup-title {
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }
    
    .popup-details {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .popup-detail {
      display: flex;
      align-items: center;
      color: #555;
      font-size: 0.9rem;
    }
    
    .popup-detail i {
      margin-right: 8px;
      color: #ff7e5f;
      width: 16px;
    }
    
    .popup-button {
      display: block;
      margin-top: 12px;
      padding: 8px 15px;
      background: linear-gradient(135deg, #ff7e5f, #feb47b);
      color: white;
      text-align: center;
      border-radius: 4px;
      text-decoration: none;
      font-weight: 500;
    }
    
    @media (min-width: 768px) {
      .container {
        flex-direction: row;
      }
      
      .sidebar {
        width: 350px;
        border-right: 1px solid #eee;
        display: flex;
        flex-direction: column;
      }
      
      #map {
        flex: 1;
      }
      
      .restaurant-list {
        position: relative;
        flex: 1;
        transform: none;
        border-radius: 0;
        box-shadow: none;
        max-height: none;
      }
      
      .list-handle {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <header>
        <div class="header-content">
          <h1><i class="fas fa-utensils"></i> Toshkent Restoranlari</h1>
          <button id="location-btn" style="background: none; border: none; color: white; font-size: 1.2rem;">
            <i class="fas fa-crosshairs"></i>
          </button>
        </div>
      </header>
      
      <div class="search-container">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" id="search-input" placeholder="Restoran nomi yoki manzili...">
        </div>
      </div>
      
      <div class="filters">
        <button class="filter-btn active">Hammasi</button>
        <button class="filter-btn">O'zbek</button>
        <button class="filter-btn">Yevropa</button>
        <button class="filter-btn">Fast Food</button>
        <button class="filter-btn">Cafe</button>
        <button class="filter-btn">Pitsa</button>
        <button class="filter-btn">Osiyo</button>
      </div>
      
      <div class="restaurant-list">
        <div class="list-handle">
          <div class="handle-icon"></div>
        </div>
        <div class="list-content" id="restaurants-container">
          <!-- Restoranlar ro'yxati JavaScript orqali to'ldiriladi -->
        </div>
      </div>
    </div>
    
    <div id="map"></div>
  </div>

  <script>
    let tg = window.Telegram.WebApp;
    tg.expand();
    
    // Demo ma'lumotlar
    const data = [
      {id: 1, name: "Oqtepa Lavash", lat: 41.3111, lng: 69.2797, rating: 4.5, cuisine: "O'zbek", address: "Farg'ona yo'li 12", phone: "+998712345678", open: "09:00 - 23:00"},
      {id: 2, name: "Caravan", lat: 41.3120, lng: 69.2850, rating: 4.7, cuisine: "Yevropa", address: "Amir Temur ko'chasi 25", phone: "+998712345679", open: "10:00 - 22:00"},
      {id: 3, name: "Socials Cafe", lat: 41.3130, lng: 69.2810, rating: 4.3, cuisine: "Cafe", address: "Navoiy ko'chasi 18", phone: "+998712345680", open: "08:00 - 00:00"},
      {id: 4, name: "Gusto Pizza", lat: 41.3029, lng: 69.2779, rating: 4.4, cuisine: "Pitsa", address: "Beruniy ko'chasi 32", phone: "+998712345681", open: "10:00 - 23:00"},
      {id: 5, name: "Anhor Food Court", lat: 41.3233, lng: 69.2792, rating: 4.2, cuisine: "Turli", address: "Anhor ko'chasi 5", phone: "+998712345682", open: "09:00 - 22:00"},
      {id: 6, name: "Plov Center", lat: 41.2962, lng: 69.2490, rating: 4.8, cuisine: "O'zbek", address: "Shota Rustaveli 44", phone: "+998712345683", open: "08:00 - 20:00"},
      {id: 7, name: "Sushi Time", lat: 41.3272, lng: 69.2815, rating: 4.6, cuisine: "Osiyo", address: "Mustaqillik maydoni 3", phone: "+998712345684", open: "11:00 - 22:00"},
      {id: 8, name: "Steak House", lat: 41.3004, lng: 69.2910, rating: 4.5, cuisine: "Yevropa", address: "Yusuf Xos Hojib 56", phone: "+998712345685", open: "12:00 - 23:00"},
      {id: 9, name: "Burger Hub", lat: 41.3180, lng: 69.2950, rating: 4.1, cuisine: "Fast Food", address: "Mirzo Ulug'bek 21", phone: "+998712345686", open: "10:00 - 23:00"},
      {id: 10, name: "Besh Qozon", lat: 41.3128, lng: 69.2702, rating: 4.7, cuisine: "O'zbek", address: "Samarqand darvoza 15", phone: "+998712345687", open: "08:00 - 21:00"},
      {id: 11, name: "Cafe Bon", lat: 41.3050, lng: 69.2720, rating: 4.4, cuisine: "Cafe", address: "Buyuk Ipak yo'li 78", phone: "+998712345688", open: "08:00 - 22:00"},
      {id: 12, name: "Italiano", lat: 41.3150, lng: 69.2890, rating: 4.6, cuisine: "Italyan", address: "Italyan ko'chasi 7", phone: "+998712345689", open: "11:00 - 23:00"},
      {id: 13, name: "BBQ Time", lat: 41.3080, lng: 69.2800, rating: 4.3, cuisine: "O'zbek", address: "Farobiy 33", phone: "+998712345690", open: "10:00 - 22:00"},
      {id: 14, name: "KFC Tashkent", lat: 41.3095, lng: 69.2750, rating: 4.0, cuisine: "Fast Food", address: "Chorsu 19", phone: "+998712345691", open: "09:00 - 23:00"},
      {id: 15, name: "Domino's Pizza", lat: 41.3140, lng: 69.2830, rating: 4.2, cuisine: "Pitsa", address: "Abdulla Qodiriy 12", phone: "+998712345692", open: "10:00 - 00:00"},
      {id: 16, name: "Shashlik House", lat: 41.2990, lng: 69.2650, rating: 4.5, cuisine: "O'zbek", address: "Alisher Navoiy 27", phone: "+998712345693", open: "11:00 - 22:00"},
      {id: 17, name: "Tandoor", lat: 41.3200, lng: 69.2900, rating: 4.4, cuisine: "Hind", address: "Bodomzor 14", phone: "+998712345694", open: "12:00 - 22:00"},
      {id: 18, name: "Coffee Inn", lat: 41.3070, lng: 69.2860, rating: 4.3, cuisine: "Cafe", address: "Fidokorlar 9", phone: "+998712345695", open: "07:00 - 21:00"},
      {id: 19, name: "Green Garden", lat: 41.3160, lng: 69.2760, rating: 4.7, cuisine: "Yevropa", address: "Yoshlik 22", phone: "+998712345696", open: "10:00 - 22:00"},
      {id: 20, name: "Lagman House", lat: 41.3100, lng: 69.3000, rating: 4.5, cuisine: "Osiyo", address: "Chinobod 16", phone: "+998712345697", open: "10:00 - 20:00"}
    ];

    // Xarita
    const map = L.map('map').setView([41.3111, 69.2797], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // MarkerCluster guruhini yaratamiz
    const markers = L.markerClusterGroup();
    
    // Foydalanuvchi joylashuvi
    let userLocation = null;
    let userMarker = null;
    
    // Joylashuv tugmasi
    document.getElementById('location-btn').addEventListener('click', () => {
      if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            userLocation = [position.coords.latitude, position.coords.longitude];
            
            // Agar oldin marker qo'yilgan bo'lsa, o'chiramiz
            if (userMarker) {
              map.removeLayer(userMarker);
            }
            
            // Yangi marker qo'yamiz
            userMarker = L.marker(userLocation, {
              icon: L.divIcon({
                className: 'custom-marker',
                html: '<i class="fas fa-user"></i>',
                iconSize: [30, 30]
              })
            }).addTo(map);
            
            // Xaritani markazlashtirish
            map.setView(userLocation, 15);
          },
          (error) => {
            console.error("Geolocation error:", error);
            alert("Joylashuvni aniqlab bo'lmadi. Iltimos, joylashuv xizmatini yoqing.");
          }
        );
      } else {
        alert("Brauzeringiz joylashuv xizmatini qo'llab-quvvatlamaydi.");
      }
    });

    // Restoranlarni qo'shish
    data.forEach(r => {
      // Har bir restoran uchun maxsus marker
      const marker = L.marker([r.lat, r.lng], {
        icon: L.divIcon({
          className: 'custom-marker',
          html: `<i class="fas fa-utensils"></i>`,
          iconSize: [30, 30]
        })
      });
      
      // Popup yaratish
      const popupContent = `
        <div class="popup-title">${r.name}</div>
        <div class="popup-details">
          <div class="popup-detail"><i class="fas fa-star"></i> ${r.rating} (500+)</div>
          <div class="popup-detail"><i class="fas fa-utensils"></i> ${r.cuisine}</div>
          <div class="popup-detail"><i class="fas fa-map-marker-alt"></i> ${r.address}</div>
          <div class="popup-detail"><i class="fas fa-phone"></i> ${r.phone}</div>
          <div class="popup-detail"><i class="fas fa-clock"></i> ${r.open}</div>
        </div>
        <a href="#" class="popup-button" data-id="${r.id}">Batafsil ma'lumot</a>
      `;
      
      marker.bindPopup(popupContent);
      
      // Marker bosilganda Telegramga ma'lumot yuborish
      marker.on("click", () => {
        tg.sendData(JSON.stringify(r));
      });
      
      markers.addLayer(marker);
    });

    map.addLayer(markers);
    
    // Restoranlar ro'yxatini yaratish
    const restaurantsContainer = document.getElementById('restaurants-container');
    
    data.forEach(r => {
      // Masofani hisoblash (agar foydalanuvchi joylashuvi ma'lum bo'lsa)
      let distanceText = '';
      if (userLocation) {
        const distance = calculateDistance(
          userLocation[0], userLocation[1], 
          r.lat, r.lng
        );
        distanceText = `${distance.toFixed(1)} km`;
      }
      
      const restaurantElement = document.createElement('div');
      restaurantElement.className = 'restaurant-item';
      restaurantElement.innerHTML = `
        <div class="restaurant-info">
          <div class="restaurant-name">${r.name}</div>
          <div class="restaurant-details">
            <div class="restaurant-rating">
              <i class="fas fa-star"></i> ${r.rating}
            </div>
            <div class="restaurant-cuisine">${r.cuisine}</div>
          </div>
        </div>
        <div class="distance">${distanceText}</div>
      `;
      
      // Ro'yxatdagi restoran bosilganda
      restaurantElement.addEventListener('click', () => {
        // Xaritaga markerni markazlashtirish
        map.setView([r.lat, r.lng], 16);
        
        // Popup ochish
        markers.getLayers().forEach(layer => {
          if (layer.getLatLng().lat === r.lat && layer.getLatLng().lng === r.lng) {
            layer.openPopup();
          }
        });
      });
      
      restaurantsContainer.appendChild(restaurantElement);
    });
    
    // Restoranlar ro'yxatini ochish/yopish
    const listHandle = document.querySelector('.list-handle');
    const restaurantList = document.querySelector('.restaurant-list');
    
    listHandle.addEventListener('click', () => {
      restaurantList.classList.toggle('expanded');
    });
    
    // Filtrlash
    const filterButtons = document.querySelectorAll('.filter-btn');
    
    filterButtons.forEach(button => {
      button.addEventListener('click', () => {
        // Faol tugmani yangilash
        filterButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        
        const filter = button.textContent;
        
        // Restoranlarni filtrlash
        const restaurantItems = document.querySelectorAll('.restaurant-item');
        
        restaurantItems.forEach(item => {
          if (filter === 'Hammasi') {
            item.style.display = 'flex';
          } else {
            const cuisine = item.querySelector('.restaurant-cuisine').textContent;
            if (cuisine === filter) {
              item.style.display = 'flex';
            } else {
              item.style.display = 'none';
            }
          }
        });
      });
    });
    
    // Qidiruv funksiyasi
    const searchInput = document.getElementById('search-input');
    
    searchInput.addEventListener('input', () => {
      const searchText = searchInput.value.toLowerCase();
      
      const restaurantItems = document.querySelectorAll('.restaurant-item');
      
      restaurantItems.forEach(item => {
        const name = item.querySelector('.restaurant-name').textContent.toLowerCase();
        
        if (name.includes(searchText)) {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      });
    });
    
    // Ikki nuqta orasidagi masofani hisoblash (Haversine formula)
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; // Yer radiusi km
      const dLat = deg2rad(lat2 - lat1);
      const dLon = deg2rad(lon2 - lon1);
      const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      const distance = R * c;
      return distance;
    }
    
    function deg2rad(deg) {
      return deg * (Math.PI/180);
    }
  </script>
</body>
</html>